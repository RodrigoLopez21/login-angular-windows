<div class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-6">
        <h1 class="text-3xl font-bold text-gray-900">Gesti√≥n de Usuarios</h1>
        <div class="flex items-center gap-3">
          <span *ngIf="currentRid !== null" class="text-sm text-gray-600">Tu rol:</span>
          <span *ngIf="currentRid === 1" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Admin</span>
          <span *ngIf="currentRid !== 1" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">User</span>
          <button 
            (click)="goBack()"
            class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
          >
            Volver
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      
      <!-- Loading spinner -->
      <div *ngIf="loading" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>

      <!-- Users Table -->
      <div *ngIf="!loading" class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apellido</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let user of users" class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.Uid }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.Uname }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.Ulastname }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.Uemail }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.Ucredential }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span [ngClass]="getStatusClass(user.Ustatus)" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                  {{ getStatusLabel(user.Ustatus) }}
                </span>
              </td>

              <!-- Rol column -->
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <!-- Always render selector; enable only for admins -->
                <select
                  [(ngModel)]="user.Rid"
                  (ngModelChange)="changeUserRole(user, $event)"
                  [disabled]="updatingRole[user.Uid]"
                  class="border rounded px-2 py-1 text-sm"
                  title="Cambiar rol"
                >
                  <option [value]="2">User</option>
                  <option [value]="1">Admin</option>
                </select>
              </td>

              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button 
                  (click)="viewLoginHistory(user)"
                  class="text-blue-600 hover:text-blue-900"
                  title="Ver historial de inicio de sesi√≥n"
                >
                  üìä Historial
                </button>
                <button 
                  (click)="toggleUserStatus(user)"
                  [disabled]="updatingStatus[user.Uid]"
                  [class]="updatingStatus[user.Uid] ? 'text-gray-400 cursor-not-allowed' : (user.Ustatus === 1 ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900')"
                  [title]="user.Ustatus === 1 ? 'Desactivar usuario' : 'Activar usuario'"
                >
                  {{ updatingStatus[user.Uid] ? '‚è≥' : (user.Ustatus === 1 ? 'üîí Desactivar' : 'üîì Activar') }}
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty state -->
        <div *ngIf="users.length === 0" class="text-center py-12">
          <p class="text-gray-500 text-lg">No hay usuarios registrados</p>
        </div>
      </div>

    </div>
  </main>

  <!-- Login History Modal -->
  <div *ngIf="showHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-900">
          Historial de Inicio de Sesi√≥n - {{ selectedUser?.Uname }} {{ selectedUser?.Ulastname }}
        </h2>
        <button 
          (click)="closeHistoryModal()"
          class="text-gray-500 hover:text-gray-700 text-2xl"
        >
          ‚úï
        </button>
      </div>

      <!-- Modal Content -->
      <div class="px-6 py-4">
        <div *ngIf="loginHistory.length === 0" class="text-center py-12">
          <p class="text-gray-500 text-lg">No hay registros de inicio de sesi√≥n</p>
        </div>

        <div *ngIf="loginHistory.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inicio de Sesi√≥n</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cierre de Sesi√≥n</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duraci√≥n</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr *ngFor="let record of loginHistory" class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900">{{ formatDate(record.Lhlogin_time) }}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  {{ record.Lhlogout_time ? formatDate(record.Lhlogout_time) : 'En sesi√≥n' }}
                </td>
                <td class="px-4 py-3 text-sm font-medium">
                  <span [class]="record.Lhlogout_time ? 'text-gray-700' : 'text-green-600 font-bold'">
                    {{ getSessionDuration(record) }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="border-t border-gray-200 px-6 py-4 text-right">
        <button 
          (click)="closeHistoryModal()"
          class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
